<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Gestor de Clientes ‚Äî ML</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0d6efd" />
  <link rel="manifest" href="manifest.json">


  <!-- AHORA TODO EL CSS EST√Å AQU√ç PARA EVITAR PROBLEMAS DE CACH√â -->
  <style>
    :root {
      --primary: #0d6efd;
      --primary-soft: #4dabff;
      --secondary: #ff7a1a;
      --bg: #050816;
      --card-bg: rgba(10, 18, 40, 0.92);
      --card-bg-contrast: rgba(255, 255, 255, 0.96);
      --text-main: #f5f5f5;
      --text-muted: #9ca3af;
      --border-soft: rgba(148, 163, 184, 0.35);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      background: var(--bg);
      color: var(--text-main);
      min-height: 100vh;
      position: relative;
    }

    /* Fondo gradiente */
    .gradient-bg {
      position: fixed;
      inset: 0;
      background:
        radial-gradient(circle at 10% 20%, rgba(13, 110, 253, 0.35) 0, transparent 55%),
        radial-gradient(circle at 90% 80%, rgba(255, 122, 26, 0.35) 0, transparent 55%);
      opacity: 0.9;
      pointer-events: none;
      z-index: -1;
    }

    /* Header */
    .app-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 1rem 1.2rem;
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(14px);
      background: linear-gradient(90deg, rgba(5, 8, 22, 0.9), rgba(5, 8, 22, 0.6));
      border-bottom: 1px solid rgba(148, 163, 184, 0.3);
    }

    .logo-circle {
      width: 42px;
      height: 42px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(145deg, var(--primary), var(--secondary));
      font-weight: 700;
      font-size: 1.1rem;
      color: white;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.7);
    }

    .title-block h1 {
      font-size: 1.25rem;
      line-height: 1.2;
    }

    .title-block p {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    /* Main */
    .app-main {
      padding: 1.1rem;
      max-width: 780px;
      margin: 0 auto 4rem;
    }

    /* Cards */
    .card {
      border-radius: 18px;
      padding: 1rem 1.1rem 1.3rem;
      margin-bottom: 1rem;
      position: relative;
      overflow: hidden;
    }

    .card-glass {
      background: radial-gradient(circle at top left, rgba(13, 110, 253, 0.16), transparent 55%),
                  radial-gradient(circle at bottom right, rgba(255, 122, 26, 0.18), transparent 55%),
                  rgba(15, 23, 42, 0.92);
      border: 1px solid var(--border-soft);
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.9);
    }

    .card-contrast {
      background: var(--card-bg-contrast);
      color: #111827;
      border: 1px solid rgba(156, 163, 175, 0.45);
    }

    .card-actions {
      background: rgba(15, 23, 42, 0.95);
      border: 1px dashed rgba(148, 163, 184, 0.6);
    }

    .card h2 {
      font-size: 1.05rem;
      margin-bottom: 0.75rem;
    }

    /* Forms */
    .form-group {
      margin-bottom: 0.8rem;
    }

    .form-group label {
      display: block;
      font-size: 0.85rem;
      margin-bottom: 0.25rem;
    }

    .form-group input {
      width: 100%;
      padding: 0.6rem 0.7rem;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.85);
      color: var(--text-main);
      font-size: 0.9rem;
      transition: border 0.15s ease, box-shadow 0.15s ease, transform 0.08s ease;
    }

    .card-contrast .form-group input {
      background: white;
      color: #111827;
    }

    .form-group input:focus {
      outline: none;
      border-color: var(--primary-soft);
      box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.8);
      transform: translateY(-1px);
    }

    .help-text {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 0.2rem;
    }

    .row-inline {
      display: flex;
      gap: 0.5rem;
    }

    .row-inline input {
      flex: 1;
    }

    .form-row-2 {
      display: flex;
      gap: 0.7rem;
      flex-wrap: wrap;
    }

    .form-row-2 .form-group {
      flex: 1;
    }

    /* Buttons */
    button {
      border: none;
      border-radius: 999px;
      padding: 0.6rem 1rem;
      font-size: 0.88rem;
      cursor: pointer;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.25rem;
      transition: transform 0.12s ease, box-shadow 0.12s ease, opacity 0.15s ease;
    }

    button:disabled {
      opacity: 0.4;
      cursor: default;
      box-shadow: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-soft));
      color: white;
      box-shadow: 0 10px 25px rgba(37, 99, 235, 0.5);
    }

    .btn-secondary {
      background: linear-gradient(135deg, var(--secondary), #ffb347);
      color: #111827;
      box-shadow: 0 10px 25px rgba(234, 88, 12, 0.4);
    }

    button:active {
      transform: translateY(1px) scale(0.97);
      box-shadow: none;
    }

    /* Rebote suave */
    .bounce {
      animation: float-in 0.4s ease-out;
    }

    @keyframes float-in {
      from {
        opacity: 0;
        transform: translateY(6px) scale(0.98);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    /* Acci√≥n group */
    .button-row {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    @media (min-width: 520px) {
      .button-row {
        flex-direction: row;
      }
    }

    /* Info actual */
    .info-actual p {
      font-size: 0.86rem;
      margin-bottom: 0.2rem;
    }

    .info-actual span {
      font-weight: 600;
      color: var(--primary);
    }

    .card-contrast .info-actual span {
      color: #1d4ed8;
    }

    .estado-texto {
      font-size: 0.86rem;
      color: var(--text-muted);
    }

    /* Toast */
    .toast {
      position: fixed;
      left: 50%;
      bottom: 1.5rem;
      transform: translateX(-50%);
      padding: 0.7rem 1.2rem;
      border-radius: 999px;
      font-size: 0.85rem;
      z-index: 9999;
      color: #fff;
      background: #111827;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.65);
    }

    .toast-info {
      background: var(--primary);
    }

    .toast-success {
      background: #16a34a;
    }

    .toast-warn {
      background: #f97316;
    }

    .toast-error {
      background: #dc2626;
    }

    .hidden {
      display: none !important;
    }

    /* Loading overlay */
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(4px);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 999;
      color: #e5e7eb;
    }

    .spinner {
      width: 46px;
      height: 46px;
      border-radius: 999px;
      border: 3px solid rgba(148, 163, 184, 0.4);
      border-top-color: var(--secondary);
      border-right-color: var(--primary);
      animation: spin 0.9s linear infinite;
      margin-bottom: 0.75rem;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .loading-overlay p {
      font-size: 0.9rem;
      color: #e5e7eb;
    }

    /* Peque√±os ajustes responsivos */
    @media (max-width: 480px) {
      .title-block h1 {
        font-size: 1.1rem;
      }
    }

    /* ===== Modal Confirm ===== */

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 99999;
      animation: fadeIn 0.25s ease-out;
    }

    .modal-card {
      width: 90%;
      max-width: 380px;
      background: #111827;
      color: #f1f5f9;
      padding: 1.5rem;
      border-radius: 18px;
      box-shadow: 0 12px 40px rgba(0,0,0,0.6);
      animation: popIn 0.25s ease-out;
    }

    .modal-card h3 {
      margin-top: 0;
      margin-bottom: 0.7rem;
      font-size: 1.15rem;
      color: var(--primary-soft);
    }

    .modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 0.6rem;
      margin-top: 1.3rem;
    }

    .btn-cancel {
      padding: 0.55rem 1.1rem;
      border-radius: 999px;
      background: #374151;
      color: #e5e7eb;
      font-size: 0.85rem;
    }

    .btn-ok {
      padding: 0.55rem 1.1rem;
      border-radius: 999px;
      background: var(--secondary);
      color: #111827;
      font-weight: 600;
      font-size: 0.85rem;
    }

    @keyframes popIn {
      from {
        opacity: 0;
        transform: scale(0.9) translateY(10px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    @keyframes fadeIn {
      from { opacity: 0 }
      to { opacity: 1 }
    }

    /* ESTILOS CLAVE PARA EL SELECTOR Y EL INPUT DE VENDEDOR */
    #vendedorSelect, #vendedorOtroInput {
      width: 100%;
      padding: 0.6rem 0.7rem;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.85);
      color: var(--text-main);
      font-size: 0.9rem;
      /* Asegura que no se comprima */
      height: auto; 
      min-height: 40px; 
    }

    .card-contrast #vendedorSelect,
    .card-contrast #vendedorOtroInput {
      background: white;
      color: #111827;
    }

    /* ESTILO DE FOCUS */
    #vendedorSelect:focus,
    #vendedorOtroInput:focus {
      outline: none;
      border-color: var(--primary-soft);
      box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.8);
      transform: translateY(-1px);
    }
    /* ===== Modal Confirm ‚Äî MEJORADO ===== */

.modal-card-lg{
  width: 94%;
  max-width: 720px; /* m√°s ancho en PC */
  padding: 1.25rem 1.25rem 1.1rem;
}

.modal-head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 0.8rem;
  margin-bottom: 0.75rem;
}

.modal-x{
  border: none;
  width: 38px;
  height: 38px;
  border-radius: 999px;
  background: rgba(255,255,255,0.08);
  color: #e5e7eb;
  font-size: 1.05rem;
  cursor: pointer;
}

.modal-x:active{ transform: scale(0.96); }

.confirm-body{
  display:flex;
  flex-direction:column;
  gap: 0.9rem;
  font-size: 0.95rem;
  line-height: 1.35;
}

/* Caja principal del resumen */
.confirm-hero{
  padding: 0.9rem;
  border-radius: 14px;
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(148,163,184,0.25);
}

.confirm-hero .hero-title{
  font-size: 1.05rem;
  font-weight: 800;
  margin-bottom: 0.35rem;
}

.confirm-hero .hero-sub{
  color: #cbd5e1;
  font-size: 0.95rem;
}

/* Grid ANTES / DESPU√âS */
.confirm-grid{
  display:grid;
  grid-template-columns: 1fr;
  gap: 0.8rem;
}

@media (min-width: 640px){
  .confirm-grid{ grid-template-columns: 1fr 1fr; }
}

.confirm-col{
  border-radius: 14px;
  padding: 0.9rem;
  border: 1px solid rgba(148,163,184,0.25);
  background: rgba(255,255,255,0.05);
}

.confirm-col h4{
  margin: 0 0 0.55rem 0;
  font-size: 1.05rem;
  font-weight: 900;
  display:flex;
  align-items:center;
  gap: 0.45rem;
}

.kv{
  display:flex;
  flex-direction:column;
  gap: 0.35rem;
  font-size: 0.98rem; /* m√°s grande */
}

.kv .row{
  display:flex;
  gap: 0.5rem;
  align-items:flex-start;
}

.kv .k{
  min-width: 120px;
  color: #93c5fd;
  font-weight: 800;
}

.kv .v{
  color: #f8fafc;
  font-weight: 600;
  word-break: break-word;
}

/* Chips */
.tag{
  display:inline-flex;
  align-items:center;
  gap: 0.35rem;
  padding: 0.25rem 0.55rem;
  border-radius: 999px;
  font-weight: 800;
  font-size: 0.85rem;
  border: 1px solid rgba(148,163,184,0.25);
  background: rgba(255,255,255,0.06);
}

.tag-ok{ background: rgba(34,197,94,0.12); border-color: rgba(34,197,94,0.35); }
.tag-warn{ background: rgba(249,115,22,0.14); border-color: rgba(249,115,22,0.38); }
.tag-info{ background: rgba(59,130,246,0.14); border-color: rgba(59,130,246,0.38); }

/* Flecha entre columnas (solo visual) */
.confirm-arrow{
  display:none;
}
@media (min-width: 640px){
  .confirm-arrow{
    display:flex;
    justify-content:center;
    align-items:center;
    font-size: 1.5rem;
    opacity: 0.9;
    margin: -0.35rem 0;
  }
}

  </style>
</head>
<body>
  <div class="gradient-bg"></div>

  <header class="app-header">
    <div class="logo-circle">ML</div>
    <div class="title-block">
      <h1>Gestor de Clientes</h1>
      <p>Alta y actualizaci√≥n sincronizada ‚Äî Bases A & B</p>
    </div>
  </header>

  <main class="app-main">
    <section class="card card-glass">
      <h2>Buscar / Crear cliente</h2>

      <div class="form-group">
        <label for="numeroInput">N√∫mero de cliente</label>
        <div class="row-inline">
          <input id="numeroInput" type="number" inputmode="numeric" placeholder="Ej: 10001" />
          <button id="btnBuscar" type="button" class="btn-primary bounce">
            Buscar
          </button>
        </div>
        <small class="help-text">Escrib√≠ el n√∫mero y toc√° "Buscar" para ver si ya existe en las bases.</small>
      </div>

      <div class="form-row-2">
        <div class="form-group">
          <label for="nombreInput">Nombre / Raz√≥n Social</label>
          <input id="nombreInput" type="text" placeholder="Perfumer√≠a Rocco" />
        </div>
        <div class="form-group">
          <label for="apellidoInput">Apellido / Referente</label>
          <input id="apellidoInput" type="text" placeholder="Opcional" />
        </div>
      </div>

      <div class="form-row-2">
        <div class="form-group">
          <label for="domicilioInput">Domicilio</label>
          <input id="domicilioInput" type="text" placeholder="Calle y n√∫mero" />
        </div>
        <div class="form-group">
          <label for="localidadInput">Localidad</label>
          <input id="localidadInput" type="text" placeholder="Ej: Guernica" />
        </div>
      </div>

      <!-- üî• AQU√ç EST√Å EL SELECTOR QUE DEBE SER VISIBLE üî• -->
      <div class="form-group">
        <label for="vendedorSelect">Vendedor</label>
        <select id="vendedorSelect">
  <option value="">Seleccionar vendedor...</option>
  <option value="SIN VENDEDOR">SIN VENDEDOR</option>
  <option value="MERCADO LIMPIO">MERCADO LIMPIO</option>
  <option value="MARTIN">MARTIN</option>
  <option value="RAMIRO">RAMIRO</option>
  <option value="OTRO">OTRO</option>
</select>


      <!-- üî• CAMPO PARA OTRO VENDEDOR (OCULTO POR DEFECTO) üî• -->
      <div class="form-group hidden" id="vendedorOtroGroup">
        <label for="vendedorOtroInput">Nombre del vendedor</label>
        <input id="vendedorOtroInput" type="text" placeholder="Escrib√≠ el nombre" />
      </div>
      <!-- FIN AGREGADO -->
    </section>

    <section id="infoActualSection" class="card card-contrast hidden">
      <h2>Cliente actual en las bases</h2>
      <div id="infoActual" class="info-actual"></div>
    </section>

    <section class="card card-actions">
      <h2>Acciones</h2>
      <p id="estadoTexto" class="estado-texto">Primero busc√° el cliente por n√∫mero.</p>

      <div class="button-row">
        <button id="btnGuardarNuevo" type="button" class="btn-primary bounce" disabled>
          Guardar como NUEVO cliente
        </button>
        <button id="btnReemplazar" type="button" class="btn-secondary bounce" disabled>
          Reemplazar datos del cliente
        </button>
      </div>
    </section>
  </main>

  <!-- Loading -->
  <div id="loadingOverlay" class="loading-overlay hidden">
    <div class="spinner"></div>
    <p>Sincronizando con la nube...</p>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast hidden"></div>

  <!-- Confirm personalizado (MEJORADO) -->
<div id="confirmOverlay" class="modal-overlay hidden">
  <div class="modal-card modal-card-lg">
    <div class="modal-head">
      <h3 id="confirmTitle">Confirmaci√≥n</h3>
      <button id="confirmX" type="button" class="modal-x" aria-label="Cerrar">‚úï</button>
    </div>

    <!-- üëá ahora es DIV para renderizar ‚Äútarjetas‚Äù -->
    <div id="confirmMessage" class="confirm-body"></div>

    <div class="modal-buttons">
      <button id="confirmCancel" class="btn-cancel">Cancelar</button>
      <button id="confirmOk" class="btn-ok">‚úÖ Confirmar</button>
    </div>
  </div>
</div>


  <!-- AHORA TODO EL JS EST√Å AQU√ç PARA EVITAR PROBLEMAS DE CACH√â -->
  <script>
    /* === CONFIG GENERAL === */
   const API_URL = "https://cool-hat-bdcf.santamariapablodaniel.workers.dev/";


    let clienteActual = null;

    document.addEventListener("DOMContentLoaded", () => {
      const numeroInput = document.getElementById("numeroInput");
      const btnBuscar = document.getElementById("btnBuscar");
      const btnGuardarNuevo = document.getElementById("btnGuardarNuevo");
      const btnReemplazar = document.getElementById("btnReemplazar");

      // === L√ìGICA AGREGADA: mostrar campo OTRO vendedor ===
      const vendedorSelect = document.getElementById("vendedorSelect");
      const vendedorOtroGroup = document.getElementById("vendedorOtroGroup");

      if (vendedorSelect && vendedorOtroGroup) {
        vendedorSelect.addEventListener("change", () => {
          const sel = vendedorSelect.value;
          
          if (sel === "OTRO") {
            vendedorOtroGroup.classList.remove("hidden");
          } else {
            vendedorOtroGroup.classList.add("hidden");
            document.getElementById("vendedorOtroInput").value = ""; // Limpiar si cambia
          }
        });
      }


      btnBuscar.addEventListener("click", buscarCliente);
      numeroInput.addEventListener("keyup", (e) => {
        if (e.key === "Enter") buscarCliente();
      });

      btnGuardarNuevo.addEventListener("click", () => guardarCliente("nuevo"));
      btnReemplazar.addEventListener("click", () => guardarCliente("reemplazo"));
    });

    /* === UI Helpers === */
    function showToast(msg, type = "info") {
      const toast = document.getElementById("toast");
      toast.textContent = msg;
      // Remueve clases previas antes de a√±adir la nueva
      toast.className = `toast toast-${type}`;
      setTimeout(() => {
        toast.className = "toast hidden";
      }, 4000);
    }

    function setEstado(texto) {
      document.getElementById("estadoTexto").textContent = texto;
    }

    function limpiarInfoActual() {
      clienteActual = null;
      const infoSection = document.getElementById("infoActualSection");
      const infoDiv = document.getElementById("infoActual");

      infoDiv.innerHTML = "";
      infoSection.classList.add("hidden");

      document.getElementById("btnGuardarNuevo").disabled = false;
      document.getElementById("btnReemplazar").disabled = true;
    }

    function toggleLoading(show) {
      const overlay = document.getElementById("loadingOverlay");
      if (show) overlay.classList.remove("hidden");
      else overlay.classList.add("hidden");
    }

    // Funci√≥n auxiliar para esperar
    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    /* === Llamada gen√©rica a la API (via Worker) === */
    // Se a√±ade l√≥gica de reintento con Retroceso Exponencial para manejar el error 429
    async function apiPost(payload, maxRetries = 3) {
      let attempt = 0;
      while (attempt < maxRetries) {
        attempt++;
        
        try {
            const resp = await fetch(API_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
            });

            if (resp.ok) {
                return await resp.json();
            }

            // Manejar error 429 (Demasiadas Solicitudes)
            if (resp.status === 429 && attempt < maxRetries) {
                // Retroceso exponencial con "jitter" (tiempo aleatorio): 2^intento * 1000ms + random(0-1000ms)
                const delay = Math.pow(2, attempt) * 1000 + (Math.random() * 1000);
                console.warn(`[API] Solicitudes excesivas (429). Reintentando en ${Math.round(delay / 1000)}s... Intento ${attempt}/${maxRetries}`);
                await sleep(delay);
                continue; // Reintentar el bucle
            }

            // Manejar otros errores HTTP o 429 despu√©s del m√°ximo de reintentos
            throw new Error("Error HTTP: " + resp.status);
            
        } catch (error) {
            // Manejar errores de red (ej. failed to fetch)
            if (attempt < maxRetries) {
                const delay = Math.pow(2, attempt) * 1000 + (Math.random() * 1000);
                console.warn(`[API] Error de red. Reintentando en ${Math.round(delay / 1000)}s... Intento ${attempt}/${maxRetries}`);
                await sleep(delay);
                continue; // Reintentar el bucle
            }
            throw error; // Relanzar el error si es el √∫ltimo intento
        }
      }
    }

    /* === Buscar cliente por n√∫mero === */
    async function buscarCliente() {
      const numero = document.getElementById("numeroInput").value.trim();

      if (!numero) {
        showToast("Ingres√° un n√∫mero de cliente", "warn");
        return;
      }

      setEstado("Buscando cliente...");
      limpiarInfoActual();
      toggleLoading(true);

      try {
        const data = await apiPost({
          action: "getCliente",
          numero,
        });

        toggleLoading(false);

        if (!data.ok) {
          showToast(data.error || "Error en la b√∫squeda", "error");
          setEstado("Error al buscar el cliente.");
          return;
        }

        if (!data.found) {
          setEstado("Cliente no encontrado. Pod√©s guardarlo como nuevo.");
          document.getElementById("btnGuardarNuevo").disabled = false;
          document.getElementById("btnReemplazar").disabled = true;
          showToast("N√∫mero libre. Es un cliente nuevo.", "info");
          return;
        }

        clienteActual = data.cliente;
        mostrarClienteActual(clienteActual);

        document.getElementById("nombreInput").value = clienteActual.nombre || "";
        document.getElementById("apellidoInput").value = clienteActual.apellido || "";
        document.getElementById("domicilioInput").value = clienteActual.domicilio || "";
        document.getElementById("localidadInput").value = clienteActual.localidad || "";
        
        // Actualiza el selector de vendedor si el cliente ya lo tiene
        const vendedorExistente = clienteActual.vendedor || "";
        const vendedorSelect = document.getElementById("vendedorSelect");
        const vendedorOtroGroup = document.getElementById("vendedorOtroGroup");
        const vendedorOtroInput = document.getElementById("vendedorOtroInput");

        if (["MARTIN", "RAMIRO", "OTRO"].includes(vendedorExistente)) {
            vendedorSelect.value = vendedorExistente;
            vendedorOtroGroup.classList.add("hidden");
            vendedorOtroInput.value = "";
        } else if (vendedorExistente) {
            // El vendedor no est√° en la lista predefinida
            vendedorSelect.value = "OTRO";
            vendedorOtroGroup.classList.remove("hidden");
            vendedorOtroInput.value = vendedorExistente;
        } else {
            // No tiene vendedor
            vendedorSelect.value = "";
            vendedorOtroGroup.classList.add("hidden");
            vendedorOtroInput.value = "";
        }


        document.getElementById("btnGuardarNuevo").disabled = true;
        document.getElementById("btnReemplazar").disabled = false;

        setEstado("El n√∫mero ya existe. Pod√©s actualizarlo.");
        showToast("Cliente encontrado.", "success");

      } catch (err) {
        console.error(err);
        toggleLoading(false);
        showToast("Error al conectar con el servidor", "error");
        setEstado("Error de conexi√≥n con la API.");
      }
    }

    function mostrarClienteActual(cli) {
      const infoSection = document.getElementById("infoActualSection");
      const infoDiv = document.getElementById("infoActual");
      
      // Agregado: Muestra tambi√©n el vendedor actual si existe
      const vendedorHtml = cli.vendedor ? `<p><span>Vendedor:</span> ${cli.vendedor}</p>` : '';

      infoDiv.innerHTML = `
        <p><span>N√∫mero:</span> ${cli.numero}</p>
        <p><span>Nombre:</span> ${cli.nombre}</p>
        <p><span>Apellido:</span> ${cli.apellido}</p>
        <p><span>Domicilio:</span> ${cli.domicilio}</p>
        <p><span>Localidad:</span> ${cli.localidad}</p>
        ${vendedorHtml}
      `;

      infoSection.classList.remove("hidden");
    }

    /* === Guardar cliente (nuevo o reemplazo) === */
    async function guardarCliente(modo) {
      const numero = document.getElementById("numeroInput").value.trim();
      const nombre = document.getElementById("nombreInput").value.trim();
      const apellido = document.getElementById("apellidoInput").value.trim();
      const domicilio = document.getElementById("domicilioInput").value.trim();
      const localidad = document.getElementById("localidadInput").value.trim();

      const vendedorSel = document.getElementById("vendedorSelect").value;
      const vendedorOtro = document.getElementById("vendedorOtroInput").value.trim();

      // === VALIDACI√ìN VENDEDOR ===
      let vendedor = "";
      if (vendedorSel === "OTRO") vendedor = vendedorOtro;
      else vendedor = vendedorSel;

      if (!vendedor) {
        showToast("Seleccion√° un vendedor", "warn");
        return;
      }

      if (!numero || !nombre || !domicilio || !localidad) {
        showToast("N√∫mero, nombre, domicilio y localidad son obligatorios", "warn");
        return;
      }

      let mensajeConfirm = "";

      if (modo === "nuevo") {
        mensajeConfirm =
          `Se va a CREAR el cliente ${numero}.\n\n` +
          `Nombre: ${nombre}\n` +
          `Domicilio: ${domicilio}\n` +
          `Localidad: ${localidad}\n` +
          `Vendedor: ${vendedor}\n\n` +
          `¬øConfirm√°s?`;
      } else {
        let viejo = "";
        if (clienteActual) {
          viejo =
            `ACTUAL:\n` +
            `Nombre: ${clienteActual.nombre}\n` +
            `Domicilio: ${clienteActual.domicilio}\n` +
            `Localidad: ${clienteActual.localidad}\n` +
            `Vendedor: ${clienteActual.vendedor || 'N/A'}\n\n`; // Muestra vendedor viejo
        }

        const nuevo =
          `NUEVO:\n` +
          `Nombre: ${nombre}\n` +
          `Domicilio: ${domicilio}\n` +
          `Localidad: ${localidad}\n` +
          `Vendedor: ${vendedor}\n\n`;

        mensajeConfirm =
          `Se van a REEMPLAZAR los datos del cliente ${numero}.\n\n` +
          viejo +
          nuevo +
          `¬øConfirm√°s?`;
      }
      const payload = {
  modo,
  numero,
  antes: (modo === "reemplazo" && clienteActual) ? {
    nombre: clienteActual.nombre || "",
    apellido: clienteActual.apellido || "",
    domicilio: clienteActual.domicilio || "",
    localidad: clienteActual.localidad || "",
    vendedor: clienteActual.vendedor || "SIN VENDEDOR"
  } : null,
  despues: {
    nombre,
    apellido,
    domicilio,
    localidad,
    vendedor
  }
};

const ok = await customConfirmRich(
  modo === "nuevo" ? "üÜï Confirmar ALTA" : "‚ôªÔ∏è Confirmar CAMBIO",
  payload
);
if (!ok) return;

      

      setEstado("Guardando cambios...");
      toggleLoading(true);

      try {
        const data = await apiPost({
          action: "guardarCliente",
          modo,
          numero,
          nombre,
          apellido,
          domicilio,
          localidad,
          vendedor // <=== ENV√çO DEL VENDEDOR NUEVO
        });

        toggleLoading(false);

        if (!data.ok) {
          showToast(data.error || "Error al guardar", "error");
          setEstado("Hubo un problema al guardar.");
          return;
        }

        showToast(data.message || "Cliente guardado correctamente", "success");
        setEstado(
          modo === "nuevo"
            ? "Cliente creado en ambas bases."
            : "Cliente actualizado en ambas bases."
        );

        // Volver a buscar para actualizar la UI con los nuevos datos
        buscarCliente();

      } catch (err) {
        console.error(err);
        toggleLoading(false);
        showToast("Error de conexi√≥n al guardar", "error");
        setEstado("Error de conexi√≥n con la API.");
      }
    }

/* =========================================================
   Confirm personalizado (RICH) ‚Äî true / false
   ========================================================= */

function escapeHtml(str) {
  return String(str ?? "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

function renderConfirmCambio(payload) {
  const numero = escapeHtml(payload.numero);
  const modo = payload.modo;

  const antes = payload.antes || null;
  const despues = payload.despues;

  const vAntes = escapeHtml(antes?.vendedor || "SIN VENDEDOR");
  const vDesp  = escapeHtml(despues?.vendedor || "SIN VENDEDOR");

  const cambioVendedor = (antes && (String(antes?.vendedor || "") !== String(despues?.vendedor || "")));

  const chipVendedor = cambioVendedor
    ? `<span class="tag tag-warn">üßë‚Äçüíº Cambia vendedor</span>`
    : `<span class="tag tag-ok">üßë‚Äçüíº Vendedor igual</span>`;

  const chipModo = (modo === "nuevo")
    ? `<span class="tag tag-info">üÜï Alta nueva</span>`
    : `<span class="tag tag-info">‚ôªÔ∏è Actualizaci√≥n</span>`;

  // Columna ‚ÄúANTES‚Äù solo si es reemplazo
  const colAntes = (modo === "reemplazo" && antes) ? `
    <div class="confirm-col">
      <h4>‚¨ÖÔ∏è ANTES</h4>
      <div class="kv">
        <div class="row"><div class="k">üë§ Nombre</div><div class="v">${escapeHtml(antes.nombre)}</div></div>
        <div class="row"><div class="k">üë• Apellido</div><div class="v">${escapeHtml(antes.apellido || "-")}</div></div>
        <div class="row"><div class="k">üìç Domicilio</div><div class="v">${escapeHtml(antes.domicilio)}</div></div>
        <div class="row"><div class="k">üèôÔ∏è Localidad</div><div class="v">${escapeHtml(antes.localidad)}</div></div>
        <div class="row"><div class="k">üßë‚Äçüíº Vendedor</div><div class="v">${vAntes}</div></div>
      </div>
    </div>
  ` : `
    <div class="confirm-col">
      <h4>‚ÑπÔ∏è Antes</h4>
      <div class="kv">
        <div class="row"><div class="k">üìå Estado</div><div class="v">Este cliente NO existe. Se va a crear.</div></div>
      </div>
    </div>
  `;

  const colDespues = `
    <div class="confirm-col">
      <h4>‚û°Ô∏è DESPU√âS</h4>
      <div class="kv">
        <div class="row"><div class="k">üë§ Nombre</div><div class="v">${escapeHtml(despues.nombre)}</div></div>
        <div class="row"><div class="k">üë• Apellido</div><div class="v">${escapeHtml(despues.apellido || "-")}</div></div>
        <div class="row"><div class="k">üìç Domicilio</div><div class="v">${escapeHtml(despues.domicilio)}</div></div>
        <div class="row"><div class="k">üèôÔ∏è Localidad</div><div class="v">${escapeHtml(despues.localidad)}</div></div>
        <div class="row"><div class="k">üßë‚Äçüíº Vendedor</div><div class="v">${vDesp}</div></div>
      </div>
    </div>
  `;

  return `
    <div class="confirm-hero">
      <div class="hero-title">üìå Cliente N¬∫ ${numero}</div>
      <div class="hero-sub">
        ${chipModo} &nbsp; ${chipVendedor}
      </div>
      <div class="hero-sub" style="margin-top:0.45rem;">
        ${modo === "nuevo"
          ? "‚úÖ Vas a CREAR un cliente nuevo."
          : "‚ö†Ô∏è Vas a REEMPLAZAR datos del cliente existente."
        }
      </div>
    </div>

    <div class="confirm-grid">
      ${colAntes}
      ${colDespues}
    </div>

    <div class="confirm-hero">
      <div class="hero-sub">üëÄ Revis√° ‚ÄúANTES‚Äù y ‚ÄúDESPU√âS‚Äù. Si est√° bien, toc√° <b>‚úÖ Confirmar</b>.</div>
    </div>
  `;
}

function customConfirmRich(titulo, payload) {
  return new Promise((resolve) => {
    const overlay = document.getElementById("confirmOverlay");
    const msgBox = document.getElementById("confirmMessage");
    const titleBox = document.getElementById("confirmTitle");

    const okBtn = document.getElementById("confirmOk");
    const cancelBtn = document.getElementById("confirmCancel");
    const xBtn = document.getElementById("confirmX");

    titleBox.textContent = titulo;
    msgBox.innerHTML = renderConfirmCambio(payload);

    overlay.classList.remove("hidden");

    function close(result) {
      overlay.classList.add("hidden");
      okBtn.removeEventListener("click", okHandler);
      cancelBtn.removeEventListener("click", cancelHandler);
      xBtn?.removeEventListener("click", xHandler);
      resolve(result);
    }

    function okHandler() { close(true); }
    function cancelHandler() { close(false); }
    function xHandler() { close(false); }

    okBtn.addEventListener("click", okHandler);
    cancelBtn.addEventListener("click", cancelHandler);
    xBtn?.addEventListener("click", xHandler);

    overlay.addEventListener("click", (e) => {
      if (e.target === overlay) close(false);
    });

    document.addEventListener("keydown", function escHandler(ev) {
      if (ev.key === "Escape") {
        document.removeEventListener("keydown", escHandler);
        close(false);
      }
    });
  });
}

  </script>
  
<script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./service-worker.js");
  }
</script>


</body>
</html>
